name: SLA Monitor

on:
  schedule:
    - cron: "0 9 * * *" # Runs every day at 9 AM UTC
  workflow_dispatch: # Allows manual triggering

jobs:
  check_sla:
    runs-on: ubuntu-latest
    steps:
      - name: Check open issues and SLA
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "critical,high,medium,low",
              per_page: 100
            });

            const now = new Date();
            const slaHours = {
              critical: 24,
              high: 48,
              medium: 120,
              low: 168
            };

            for (const issue of issues.data) {
              const createdAt = new Date(issue.created_at);
              const ageInHours = (now - createdAt) / 36e5;

              const label = issue.labels.map(l => l.name).find(n => ['critical', 'high', 'medium', 'low'].includes(n));

              if (label && ageInHours > slaHours[label]) {
                console.log(`⚠️ Issue #${issue.number} has exceeded SLA for ${label} (${ageInHours.toFixed(1)} hrs old).`);

                // Optional: Add a comment to the issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `⚠️ This issue has exceeded the SLA for **${label}** priority. Please address it as soon as possible.`
                });
              }
            }
